GreenEggs = angular.module('GreenEggs', ['ngResource', 'rails', 'ui', 'ui.bootstrap'])

filepicker.setKey('AffEtHmTETGO3pTJxeyo7z')

GreenEggs.factory "Poll", ["railsResourceFactory", (railsResourceFactory) ->
  railsResourceFactory
    url: "/api/polls"
    name: "poll"
]

GreenEggs.factory "User", ["railsResourceFactory", (railsResourceFactory) ->
  railsResourceFactory
    url: "/api/users"
    name: "user"
]


GreenEggs.factory "Ballot", ["railsResourceFactory", (railsResourceFactory) ->
  railsResourceFactory
    url: "/api/ballots"
    name: "ballot"
]

GreenEggs.directive "selectPeople", ->
  {
  restrict: 'E'
  scope:
    currentPerson: "=currentPerson"
    choose: "&"
  templateUrl:"<%= asset_path 'views/directives/select_people.html' %>"
  }

GreenEggs.directive "switch", ->
  {
  restrict: 'E'
  scope:
    choose: "&"
  templateUrl:"<%= asset_path 'views/directives/switch.html' %>"
  }

GreenEggs.controller "SelectUserCtrl", ["$scope", "$http", "Poll", "Ballot", "$routeParams", "$location", "$dialog", ($scope, $http, Poll, Ballot, $routeParams, $location, $dialog) ->
  users = Poll.query(query: $scope.search).then((polls) ->
    $scope.polls = polls
  )
]
GreenEggs.controller "SwitchCtrl", ["$scope", ($scope) ->
  $scope.greenSwitchStatus = true
  $scope.switch = ->
    if $scope.greenSwitchStatus == true
      greenSwitchStatus = false
    else
      greenSwitchStatus = true
    $scope.greenSwitchStatus = greenSwitchStatus
]


GreenEggs.controller "HeaderCtrl", ["$scope", "$http",  "$routeParams", "$location", "$dialog", ($scope, $http, $routeParams, $location, $dialog) ->
  $scope.currentUser = window.current_user
  $location.hideHeader = true if $location.url() == "/"
  $scope.$on "$routeChangeSuccess", (next, current) ->
    $scope.hideHeader = true if $location.url() == "/"
    $scope.hideHeader = false if $location.url() != "/"

]


GreenEggs.controller "MainCtrl", ["$scope", "$http", "Poll", "$routeParams", "$location", "$dialog", ($scope, $http, Poll, $routeParams, $location, $dialog) ->

]
GreenEggs.controller "PollsCtrl", ["$scope", "$http", "Poll", "Ballot", "$routeParams", "$location", "$dialog", ($scope, $http, Poll, Ballot, $routeParams, $location, $dialog) ->
  users = Poll.query(query: $scope.search).then((polls) ->
    $scope.polls = polls
  )
]

GreenEggs.controller "PollCtrl", ["$scope", "$http", "Poll", "Ballot", "$routeParams", "$location", "$dialog", ($scope, $http, Poll, Ballot, $routeParams, $location, $dialog) ->
  $scope.id = $routeParams.id
  $scope.ballot = {}
  $scope.ballot.choices = []
  Poll.get(id:  $scope.id).then((poll) =>
    $scope.poll = poll
  )
  $ ->
    $(".sortable").sortable()
    $(".sortable").disableSelection()

  $scope.setSwipe = (n) ->
    console.log "setting swiping for option#{n}"
    setTimeout ( =>
      #$(".option#{n}").css("background", "red")
      if n != ""
        $(".option#{n}").swipe
          swipeUp: (event, direction, distance, duration, fingerCount) ->
            $scope.up($(event.target).data("index"))
            $scope.$apply()
          swipeDown: (event, direction, distance, duration, fingerCount) ->
            $scope.down($(event.target).data("index"))
            $scope.$apply()
          swipeLeft: (event, direction, distance, duration, fingerCount) ->
            element = $(event.target)
            index = element.data("index")
            if index >= 0
              element.parent().css("margin-left", "-110%")
              setTimeout ( =>
                element.parent().hide()
                setTimeout ( =>
                  $scope.removeChoice($scope.ballot.choices[index], index)
                  $scope.$apply()
                ), 300
              ), 300
          swipeRight: (event, direction, distance, duration, fingerCount) ->
            element = $(event.target)
            index = element.data("index")
            if index >= 0
              element.parent().css("margin-left", "110%")
              setTimeout ( =>
                element.parent().hide()
                setTimeout ( =>
                  $scope.removeChoice($scope.ballot.choices[index], index)
                  $scope.$apply()
                ), 300
              ), 300
    ), 100


  $scope.addChoice = (choice, index) ->
    $scope.ballot.choices.push(choice)
    $scope.poll.choices.splice(index, 1)
    #$scope.setSwipe($scope.ballot.choices.length - 1)
  $scope.removeChoice = (choice, index) ->
    $scope.poll.choices.push(choice)
    $scope.ballot.choices.splice(index, 1)
  $scope.up = (index) ->
    if index > 0
      c = $scope.ballot.choices[index]
      $scope.ballot.choices[index] =  $scope.ballot.choices[index - 1]
      $scope.ballot.choices[index - 1] = c

  $scope.down = (index) ->
    console.log "down"
    if index + 2 <= $scope.ballot.choices.length
      c = $scope.ballot.choices[index]
      $scope.ballot.choices[index] =  $scope.ballot.choices[index + 1]
      $scope.ballot.choices[index + 1] = c

  $scope.saveBallot = (choices) ->
    new Ballot(poll_id:$scope.poll._id, id:$scope.poll._id, choices: $scope.ballot.choices).update().then (result) ->
      $scope.poll = result
      $location.path("/stats/#{result.pollId}")

    console.log "Choices are already saved in javascript variable inside your browser."
]

GreenEggs.controller "StatsCtrl", ["$scope", "$http", "Poll", "Ballot", "$routeParams", "$location", "$dialog", ($scope, $http, Poll, Ballot, $routeParams, $location, $dialog) ->
  $scope.id = $routeParams.id
  $scope.ballot = {}
  $scope.ballot.choices = []
  Poll.get(id:  $scope.id).then((poll) =>
    $scope.poll = poll
    console.log poll
    $scope.data = []
    angular.forEach(poll.calculateBorda, (p) ->
      $scope.data.push
        value:p.tally*100
        color:"rgb(#{Math.floor(Math.random()*255)},#{Math.floor(Math.random()*255)},#{Math.floor(Math.random()*255)})"
        label:p.original
    )
    myNewChart = new Chart($("#canvas").get(0).getContext("2d")).Pie($scope.data)
  )

]

GreenEggs.controller "CreateCtrl", ["$scope", "$http", "Poll", "$routeParams", "$location", "$dialog", ($scope, $http, Poll, $routeParams, $location, $dialog) ->
  $scope.poll = {}
  $scope.poll.choices = []

  $scope.addChoice = (choice) ->
    $scope.poll.choices.push($.extend({}, choice))
    $scope.newChoice = ""
  $scope.removeChoice = (index) ->
    $scope.poll.choices.splice(index, 1)


  $scope.savePoll = (poll) ->
    new Poll(poll).create().then (result) ->
      $scope.poll = result
      $location.path("/polls/#{result._id}")

  #$scope.saveImage()
]
#****************************************
#* Router
#****************************************

# Page title manipulations

GreenEggs.config ["$locationProvider", "$routeProvider", ($locationProvider, $routeProvider) ->
  $locationProvider.html5Mode(true).hashPrefix('!')
  $routeProvider.when("/",
    templateUrl: "<%= asset_path 'views/main.html' %>"
  ).when("/create",
    templateUrl: "<%= asset_path 'views/create.html' %>"
  ).when("/polls/:id",
    templateUrl: "<%= asset_path 'views/poll.html' %>"
  ).when("/stats/:id",
    templateUrl: "<%= asset_path 'views/stats.html' %>"
  ).when("/polls",
    templateUrl: "<%= asset_path 'views/polls.html' %>"
  )
]
