GreenEggs = angular.module('GreenEggs', ['ngResource', 'rails', 'ui', 'ui.bootstrap'])

filepicker.setKey('AffEtHmTETGO3pTJxeyo7z')

GreenEggs.factory "Poll", ["railsResourceFactory", (railsResourceFactory) ->
  railsResourceFactory
    url: "/api/polls"
    name: "poll"
]

GreenEggs.controller "MainCtrl", ["$scope", "$http", "Poll", "$routeParams", "$location", "$dialog", ($scope, $http, Poll, $routeParams, $location, $dialog) ->

]

GreenEggs.controller "PollCtrl", ["$scope", "$http", "Poll", "$routeParams", "$location", "$dialog", ($scope, $http, Poll, $routeParams, $location, $dialog) ->
  $scope.id = $routeParams.id
  $scope.ballot = {}
  $scope.ballot.choices = []
  Poll.get(id:  $scope.id).then((poll) =>
    $scope.poll = poll
  )
  $scope.votedChoice = (choice) ->
    result = false
    angular.forEach($scope.ballot.choices, (c) ->
      result = true if c == choice
    )
    result

  $scope.addChoice = (choice) ->
    if not $scope.votedChoice(choice)
      $scope.ballot.choices.push(choice)
    else
      console.log "pushed already", choice
  $scope.removeChoice = (index) ->
    $scope.ballot.choices.splice(index, 1)

]


GreenEggs.controller "CreateCtrl", ["$scope", "$http", "Poll", "$routeParams", "$location", "$dialog", ($scope, $http, Poll, $routeParams, $location, $dialog) ->
  $scope.poll = {}
  $scope.poll.choices = []

  $scope.addChoice = (choice) ->
    $scope.poll.choices.push($.extend({}, choice))
    $scope.newChoice = ""

  $scope.savePoll = (poll) ->
    new Poll(poll).create().then (result) ->
      $scope.poll = result
      $location.path("/polls/#{result._id}")

  #$scope.saveImage()
]
#****************************************
#* Router
#****************************************

# Page title manipulations

GreenEggs.config ["$locationProvider", "$routeProvider", ($locationProvider, $routeProvider) ->
  $locationProvider.html5Mode(true).hashPrefix('!')
  $routeProvider.when("/",
    templateUrl: "<%= asset_path 'views/main.html' %>"
  ).when("/create",
    templateUrl: "<%= asset_path 'views/create.html' %>"
  ).when("/polls/:id",
    templateUrl: "<%= asset_path 'views/poll.html' %>"
  )
]
